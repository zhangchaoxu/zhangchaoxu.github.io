---
layout:     post
categories: "tech"
title:      "Java Web定时执行任务"
subtitle:   "Tomcat Timer Task"
date:       2012-07-09 01:41
author:     "Charles"
---

这是前阵子在做交大数字校园项目时候遇到的一个问题。
**需求:** 需要每天定时如凌晨3点执行一次采集数据的任务。
**解决方案:**
第一步：在web.xml配置文件中加了一个监听器</p>  <blockquote>   <p>&lt;!-- 配置定时任务监听器 --&gt;      <br />&#160;&#160;&#160; &lt;listener&gt;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;listener-class&gt;bjtu.wap.service.AcquistionTaskManager&lt;/listener-class&gt;       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;description&gt;Atuo Task To Acquiste&lt;/description&gt;       <br />&#160;&#160;&#160; &lt;/listener&gt;&#160;&#160; </p> </blockquote>  <p>&#160;&#160;&#160; 第二步：写一个实现ServletContextListener接口的监听器类。</p>  <blockquote>   <p>public class AcquistionTaskManager implements ServletContextListener { </p>    <p>&#160;&#160;&#160; public static final long PERIOD_DAY = 24 * 60 * 60 * 1000; </p>    <p>&#160;&#160;&#160; private Timer timer; </p>    <p>&#160;&#160;&#160; /**      <br />&#160;&#160;&#160;&#160; * * 在Web应用启动时初始化任务       <br />&#160;&#160;&#160;&#160; */       <br />&#160;&#160;&#160; public void contextInitialized(ServletContextEvent event) {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; // 第二天的03:00:00开始执行，执行频率为1天       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Calendar curtime = Calendar.getInstance();       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; //curtime.set(Calendar.DATE, curtime.get(Calendar.DATE) + 1);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; int y = curtime.get(Calendar.YEAR);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; int m = curtime.get(Calendar.MONTH);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; int d = curtime.get(Calendar.DAY_OF_MONTH); </p>    <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; /*** 定制每日3:00执行方法 ***/      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; curtime.set(y, m, d, 3, 30, 0);       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; Date date = curtime.getTime(); </p>    <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; Timer timer = new Timer();      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; AcquTask task = new AcquTask(); </p>    <p>&#160;&#160;&#160;&#160;&#160;&#160;&#160; // 安排指定的任务在指定的时间开始进行重复的固定延迟执行。      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; timer.schedule(task, date, PERIOD_DAY);       <br />&#160;&#160;&#160; } </p>    <p>&#160;&#160;&#160; /**      <br />&#160;&#160;&#160;&#160; * * 在Web应用结束时停止任务       <br />&#160;&#160;&#160;&#160; */       <br />&#160;&#160;&#160; public void contextDestroyed(ServletContextEvent event) {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; if (timer != null) {       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; timer.cancel(); // 定时器销毁       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160; }       <br />}</p>    <p></p> </blockquote>  <p>&#160;&#160;&#160; 第三步：写一个继承TimerTask的任务类，将要执行的任务放在run方法中。</p>  <blockquote>   <p>public class BackTimerTask extends TimerTask { </p>    <p>// 在run()方法中调用对数据库的备份操作 </p>    <p>public void run() {</p>    <p>this.doit(); </p>    <p>}</p>    <p>private void doit() { </p>    <p>System.out.println(&quot;---------------------&quot;};</p>    <p>}</p> </blockquote>  <p><strong><font color="#ff0000">问题：</font></strong></p>  <p>&#160; run方法中的内容，每次都会执行两次。</p>  <p><strong>问题解决：</strong></p>  <p><strong>&#160;&#160; </strong>由于我是在tomcat中调试运行的，tomcat默认的appBase是“Webapps”，他会将timer加载到容器中，我们后面又单独设置了一个 &lt;Context path=&quot;&quot; docBase=&quot;../webapps/wap&quot; /&gt; 相当于将icms里面的配置加载了两次，导致每次timer执行两次。</p>  <p>&#160;&#160; 将项目移到与webapp是同级的目录中即可。docBase=&quot;../wap&quot;</p>